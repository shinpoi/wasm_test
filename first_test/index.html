<head>
	<style>
		img{
			max-width: 720px;
			max-height: 720px;
			border: 1px solid black;
			margin: 0.5em;
		}
	</style>
</head>

<body>
	<input id="input_src" Xdraw="src_img" type="file" accept="image/*" />Srcouce File<br/>
	<img id="src_img" src=""></img><br/>

	<img id="res_img" src=""></img><br/>

	<input id="input_ref" Xdraw="ref_img" type="file" accept="image/*" />Referrence File<br/>
	<img id="ref_img" src=""></img><br/>
	
	<button onclick="colorMatch()">button!</button>

<script type="text/javaScript">
	var input_src = document.getElementById("input_src");
	var input_ref = document.getElementById("input_ref");

	input_src.addEventListener('change', readFile, false);
	input_ref.addEventListener('change', readFile, false);

	function readFile(){
		console.time('Read image and display');
		var file = this.files[0];
		if (!/image\/[a-zA-Z]+/.test(file.type)){
			alert("Please upload a Image!");
			//return false;
		}
		var reader = new FileReader();
		reader.readAsDataURL(file);
		var Xdraw = this.getAttribute('Xdraw'); 
		reader.onload = function(e){
			displayAsImage(this.result, Xdraw);
		console.timeEnd('Read image and display');
		}
	}

	function displayAsImage(data, id_){
		document.getElementById(id_).src = data;
	}

</script>
<script type="text/javaScript" src="test.js"></script>
<script>
var mem = new WebAssembly.Memory({initial:1000, maximum:2000})
function colorMatch(){
	console.time('Pretreatment image data');
	// get ImgElement
	src_img_or = document.getElementById("src_img");
	ref_img_or = document.getElementById("ref_img");
	
	// to origin-size Image
	var src_img = new Image;
	var ref_img = new Image;
	src_img.src = src_img_or.src;
	ref_img.src = ref_img_or.src;
	
	// draw img to canvas
	src_cv = document.createElement('canvas');
	src_cv.width = src_img.width;
	src_cv.height = src_img.height;
	src_ctx = src_cv.getContext('2d');
	src_ctx.drawImage(src_img, 0, 0);

	ref_cv = document.createElement('canvas');
	ref_cv.width = ref_img.width;
	ref_cv.height = ref_img.height;
	ref_ctx = ref_cv.getContext('2d');
	ref_ctx.drawImage(ref_img, 0, 0);

	// send to wasm
	data_src = src_ctx.getImageData(0, 0, src_img.width, src_img.height);
	len_src = src_img.width * src_img.height * 4;
	buffer_src = new Uint8Array(mem.buffer, 1024, len_src);
	buffer_src.set(data_src.data);

	data_ref = ref_ctx.getImageData(0, 0, ref_img.width, ref_img.height);
	len_ref = ref_img.width * ref_img.height * 4;
	buffer_ref = new Uint8Array(mem.buffer, 2048 + len_src, len_ref);
	buffer_ref.set(data_ref.data);	
	console.timeEnd('Pretreatment image data');
	console.time('WASM');
	// input data
	_histMatch(buffer_src, buffer_ref, len_src, len_ref);
	console.timeEnd('WASM');
	
	console.time('Output image');
	// output data
	data_src.data.set(buffer_src);
	src_ctx.putImageData(data_src, 0, 0);
	dataURL = src_cv.toDataURL('image/png');
	
	document.getElementById('res_img').src = dataURL;
	console.timeEnd('Output image');
}
</script>

</body>
